<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>Visor 3D Bhastian</title>

        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background-color: #111; }
            
            /* PANTALLA DE INICIO / CARGA */
            #overlay-container {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: white; /* O puedes poner un degradado dorado */
                z-index: 9999;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                transition: opacity 0.8s ease-out;
            }

            #overlay-logo { max-width: 50%; height: auto; margin-bottom: 20px; }
            
            #loading-text { font-size: 16px; color: #666; animation: blink 1.5s infinite; }

            /* BOTÓN DE INICIO */
            #start-button {
                display: none; /* Se oculta hasta cargar */
                width: 130px; height: 130px;
                background: radial-gradient(circle, #d4af37 0%, #b8962e 100%);
                color: white; border-radius: 50%; border: 4px solid #fff;
                font-size: 16px; font-weight: bold; cursor: pointer;
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
                animation: pulse 2s infinite;
            }

            @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.5} }
            @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
            .fade-out { opacity: 0; pointer-events: none; }

            /* WHATSAPP */
            #whatsapp-button {
                display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9998;
            }
            #whatsapp-button img { width: 50px; height: 50px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }
        </style>

        <script>
            // LÓGICA PRINCIPAL
            AFRAME.registerComponent('app-manager', {
                init: function () {
                    const model = document.querySelector("#animatedModel");
                    const overlay = document.querySelector("#overlay-container");
                    const loadTxt = document.querySelector("#loading-text");
                    const startBtn = document.querySelector("#start-button");
                    const audio = document.querySelector("#bg-music");
                    const clickFx = document.querySelector("#click-sound");
                    const waBtn = document.querySelector("#whatsapp-button");

                    // 1. Cuando el modelo 3D está listo
                    model.addEventListener('model-loaded', () => {
                        loadTxt.style.display = 'none';
                        startBtn.style.display = 'block';
                    });

                    // 2. Cuando el usuario hace click para entrar
                    startBtn.addEventListener('click', () => {
                        // Reproducir sonido click
                        if(clickFx) clickFx.play().catch(e=>{});
                        
                        // Quitar pantalla de carga
                        overlay.classList.add('fade-out');
                        setTimeout(() => { overlay.style.display = 'none'; }, 800);

                        // Mostrar Whatsapp
                        waBtn.style.display = 'block';

                        // ACTIVAR MÚSICA (Aquí es donde el navegador nos da permiso)
                        if(audio) {
                            audio.volume = 1.0;
                            audio.play();
                        }
                    });
                }
            });

            // GESTOS (ROTAR Y ZOOM) - Simplificado para 3D
            AFRAME.registerComponent('model-controls', {
                init: function () {
                    this.el.sceneEl.addEventListener('touchmove', (e) => {
                        if (e.touches.length === 1) {
                            // Rotar modelo con 1 dedo
                            this.el.object3D.rotation.y += e.movementX * 0.005;
                        }
                    });
                    // Puedes agregar zoom aquí si quieres, pero A-Frame tiene controles de cámara por defecto
                }
            });
        </script>
    </head>

    <body>
        <div id="overlay-container">
            <img id="overlay-logo" src="assets/logo.png" alt="Bhastian">
            <div id="loading-text">Cargando Experiencia 3D...</div>
            <button id="start-button">VER<br>EXPERIENCIA</button>
        </div>

        <a href="https://wa.me/593983088889" target="_blank" id="whatsapp-button">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
        </a>

        <audio id="bg-music" src="assets/audio.mp3" loop></audio>
        <audio id="click-sound" src="assets/click.mp3"></audio>

        <a-scene 
            app-manager 
            loading-screen="enabled: false" 
            renderer="colorManagement: true; antialias: true;"
            background="color: #222222"
            vr-mode-ui="enabled: false">
            
            <a-assets>
                <a-asset-item id="modeloGLB" src="assets/tanjirofinal4.glb"></a-asset-item>
            </a-assets>

            <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
            <a-light type="directional" position="-1 1 1" intensity="0.5"></a-light>

            <a-entity camera position="0 1.6 2" look-controls="enabled: false"></a-entity>

            <a-entity 
                id="animatedModel"
                gltf-model="#modeloGLB"
                position="0 0 -1"
                scale="0.012 0.012 0.012"
                animation-mixer="loop: repeat"
                model-controls
            ></a-entity>

        </a-scene>
    </body>
</html>
